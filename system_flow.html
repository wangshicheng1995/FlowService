<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowService - ç³»ç»Ÿæµç¨‹å›¾</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background-color: #f4f4f9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ“¸ å›¾ç‰‡ä¸Šä¼ ä¸åˆ†ææµç¨‹å›¾</h1>
        <div class="mermaid">
            sequenceDiagram
            autonumber
            actor User as ç”¨æˆ· (User)
            participant Controller as ImageController
            participant Service as ImageProcessService
            participant AI as QwenApiService (AI)
            participant Impact as ImpactAnalysisService
            participant Calc as HealthTagCalculator
            participant DBService as MealRecordService
            participant DB as Database

            Note over User, Controller: 1. ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
            User->>Controller: POST /upload (image)
            Controller->>Service: processFoodAnalysis(request)

            rect rgb(240, 248, 255)
            Note over Service, AI: 2. é£Ÿç‰©è¯†åˆ«ä¸åŸºç¡€è¥å…»åˆ†æ
            Service->>Service: éªŒè¯å›¾ç‰‡æ•°æ®
            Service->>AI: callQwenVisionApi (Prompt: FOOD_NUTRITION)
            AI-->>Service: è¿”å› JSON (é£Ÿç‰©åˆ—è¡¨, åŸºç¡€è¥å…»)
            Service->>Service: è§£æ JSON -> FoodAnalysisResponse
            end

            rect rgb(255, 245, 238)
            Note over Service, Impact: 3. å¥åº·å½±å“åˆ†æ (æ–°å¢åŠŸèƒ½)
            alt è§£ææˆåŠŸä¸”åŒ…å«è¥å…»æ•°æ®
            Service->>Impact: analyzeImpact(MealNutrition)
            Impact->>Calc: calcTags(MealNutrition)
            Calc-->>Impact: è¿”å› Set&lt;NutritionTag&gt; (å¦‚ HIGH_SODIUM)
            Impact->>Impact: æ„å»º Prompt (å«è¥å…»æ•°æ® + æ ‡ç­¾)
            Impact->>AI: callQwenApi (Prompt: MEAL_IMPACT)
            AI-->>Impact: è¿”å› JSON (çŸ­ä¸­é•¿æœŸå½±å“)
            Impact-->>Service: ImpactAnalysisResult
            Service->>Service: å¡«å……åˆ° FoodAnalysisResponse
            end
            end

            rect rgb(240, 255, 240)
            Note over Service, DB: 4. æ•°æ®æŒä¹…åŒ–
            Service->>DBService: saveMealRecord(response)
            DBService->>DBService: æ„å»º MealRecord & MealNutrition
            DBService->>DB: ä¿å­˜åˆ° meal_records è¡¨
            DBService->>DB: ä¿å­˜åˆ° meal_nutrition è¡¨ (çº§è”ä¿å­˜)
            end

            Service-->>Controller: è¿”å›å®Œæ•´ FoodAnalysisResponse
            Controller-->>User: ApiResponse.success(data)
        </div>
    </div>
</body>

</html>